<!DOCTYPE html>
<html>
  <head>
    <title>Multi-Group GeoJSON Visualization</title>
    <style>
        #map { height: 80vh; width: 100%; }
        #controls { padding: 10px; background: #f0f0f0; }
        .info-window-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 5px;
    box-sizing: border-box;
}

.info-window-content {
    color: #333;
    font-family: Arial, sans-serif;
    font-size: 12px;
    line-height: 1.2;
    white-space: nowrap;
    text-align: center;
}
        .gm-style .gm-style-iw-c {
            padding: 12px !important;
            border-radius: 4px !important;
        }
        .gm-style .gm-style-iw-t::after {
            display: none;
        }
        .gm-style .gm-style-iw-d {
            overflow: hidden !important;
        }
        .gm-ui-hover-effect {
            display: none !important;
        }

        .checkbox-group {
    display: flex;
    gap: 10px;
    max-width: 100%;
    overflow-x: auto;
}

.checkbox-column {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.checkbox-wrapper {
    display: flex;
    align-items: center;
}

.checkbox-wrapper input[type="checkbox"] {
    margin-right: 5px;
}

.checkbox-wrapper label {
    display: flex;
    align-items: center;
    cursor: pointer;
    white-space: nowrap;
}

.color-swatch {
    width: 20px;
    height: 20px;
    display: inline-block;
    margin-right: 5px;
    border: 1px solid #ccc;
}

@media (max-width: 768px) {
    .checkbox-group {
        flex-direction: column;
    }
}
    </style>
  </head>
  <body>
    <div id="controls"></div>
    <div id="map"></div>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAwaRblgM3CzCrB_7B9tP5wSNQQqpXc_WU&callback=initMap"
      async defer></script>
    <script>
        var map;
        var infoWindow;
        var dataLayers = {};
        var peopleGroups = [
            "Bhutanese",
            "Burmese",
            "Cambodian",
            "Chinese",
            "Filipino",
            "Hmong",
            "Indonesian",
            "Japanese",
            "Korean",
            "Laotian",
            "Malaysian",
            "Mongolian",
            "Nepalese",
            "Thai",
            "Vietnamese"
        ];

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 5,
                center: { lat: 39.8283, lng: -98.5785 } // Center of United States, Kansas!
            });

            infoWindow = new google.maps.InfoWindow({
                disableAutoPan: true
            });

            createCheckboxes();
        }

        function createCheckboxes() {
    const controlsDiv = document.getElementById('controls');
    controlsDiv.innerHTML = ''; // Clear existing content

    const form = document.createElement('form');
    form.className = 'checkbox-group';

    // Create column containers
    const columns = [
        document.createElement('div'),
        document.createElement('div'),
        document.createElement('div')
    ];
    columns.forEach(column => {
        column.className = 'checkbox-column';
        form.appendChild(column);
    });

    // Sort people groups alphabetically
    const sortedGroups = [...peopleGroups].sort((a, b) => a.localeCompare(b));

    // Calculate items per column
    const itemsPerColumn = Math.ceil(sortedGroups.length / 3);

    sortedGroups.forEach((group, index) => {
        const checkboxId = `checkbox-${group.toLowerCase().replace(/\s+/g, '-')}`;

        const checkboxWrapper = document.createElement('div');
        checkboxWrapper.className = 'checkbox-wrapper';

        const checkbox = document.createElement('input');
        checkbox.type = "checkbox";
        checkbox.id = checkboxId;
        checkbox.value = group;
        checkbox.checked = false; // Set to checked by default
        checkbox.addEventListener('change', handleCheckboxChange);

        const label = document.createElement('label');
        label.htmlFor = checkboxId;
        label.textContent = group;

        const colorSwatch = document.createElement('span');
        colorSwatch.className = 'color-swatch';
        colorSwatch.style.backgroundColor = getBaseColor(5, group); // Using 5 for a medium shade

        label.prepend(colorSwatch);
        checkboxWrapper.appendChild(checkbox);
        checkboxWrapper.appendChild(label);

        // Distribute checkboxes across columns vertically
        const columnIndex = Math.floor(index / itemsPerColumn);
        columns[columnIndex].appendChild(checkboxWrapper);
    });

    controlsDiv.appendChild(form);
}

        function handleCheckboxChange(event) {
            var group = event.target.value;
            if (event.target.checked) {
                loadGeoJSON(group);
            } else {
                removeGeoJSON(group);
            }
        }

        function loadGeoJSON(group) {
            fetch(`data/${group}.geojson`)
            .then(response => response.json())
                .then(data => {
                    var layer = new google.maps.Data();
                    layer.addGeoJson(data);
                    layer.setStyle(feature => styleFeature(feature, group));
                    layer.setMap(map);
                    dataLayers[group] = layer;

                    layer.forEach(feature => {
                        feature.setProperty('group', group);
                        // feature.setProperty('colorScale', group);
                    });

                    layer.addListener('mouseover', handleMouseOver);
                    layer.addListener('mouseout', handleMouseOut);
                })
                .catch(error => {
                    console.error(`Error loading ${group}.geojson:`, error);
                    alert(`Failed to load ${group}.geojson. Check console for details.`);
                });
        }

        function removeGeoJSON(group) {
            if (dataLayers[group]) {
                dataLayers[group].setMap(null);
                delete dataLayers[group];
            }
        }

        function handleMouseOver(event) {
    var feature = event.feature;
    var group = feature.getProperty('group');
    dataLayers[group].overrideStyle(feature, {fillOpacity: 0.8});

    var placeName = event.feature.getProperty('NAME');
    var population = event.feature.getProperty('population');
    
    infoWindow.setContent(
        '<div class="info-window-wrapper">' +
            '<div class="info-window-content">' +
                '<strong>' + placeName + '</strong>: ' + 
                population.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") +
            '</div>' +
        '</div>'
    );
    infoWindow.setPosition(event.latLng);
    infoWindow.open(map);
}

function handleMouseOut(event) {
    var feature = event.feature;
    var group = feature.getProperty('group');
    dataLayers[group].revertStyle();
    infoWindow.close();
}

        function styleFeature(feature, group) {
            // console.log(feature.get);

            var population = feature.getProperty('population');
            var colorScale = feature.getProperty('colorscale');
            var color = getColor(colorScale, group);
            return {
                fillColor: color,
                strokeColor: color,
                strokeWeight: 1,
                fillOpacity: 0.7
            };
        }

        const colorPalette = [
            '#FF0000', // Red
            '#00FF00', // Lime
            '#0000FF', // Blue
            '#FFFF00', // Yellow
            '#FF00FF', // Magenta
            '#00FFFF', // Cyan
            '#800000', // Maroon
            '#008000', // Green
            '#000080', // Navy
            '#808000', // Olive
            '#800080', // Purple
            '#008080', // Teal
            '#FFA500', // Orange
            '#A52A2A', // Brown
            '#FFC0CB', // Pink
        ];

        function getBaseColor(value, group) {
            const index = peopleGroups.indexOf(group);
            const baseColor = colorPalette[index];
            return baseColor;
        }

        function hexToHsl(hex) {
    let r = parseInt(hex.slice(1, 3), 16) / 255;
    let g = parseInt(hex.slice(3, 5), 16) / 255;
    let b = parseInt(hex.slice(5, 7), 16) / 255;

    let max = Math.max(r, g, b), min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;

    if (max === min) {
        h = s = 0; // achromatic
    } else {
        let d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
    }

    return { h: h * 360, s: s * 100, l: l * 100 };
}

function hslToHex(h, s, l) {
    l /= 100;
    const a = s * Math.min(l, 1 - l) / 100;
    const f = n => {
        const k = (n + h / 30) % 12;
        const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
        return Math.round(255 * color).toString(16).padStart(2, '0');
    };
    return `#${f(0)}${f(8)}${f(4)}`;
}

function getColor(colorScale, group) {
    const index = peopleGroups.indexOf(group);
    const baseColor = colorPalette[index];
    const hsl = hexToHsl(baseColor);

    // Adjust lightness based on colorScale (1-10)
    // Map colorScale 1-10 to lightness 80%-20% (reversed from before)
    const lightness = 80 - (colorScale - 1) * 6;

    // Keep the original hue and saturation, but use the new lightness
    return hslToHex(hsl.h, hsl.s, lightness);
}

    </script>
  </body>
</html>